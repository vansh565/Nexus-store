<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy Now - NEXUS Store</title>
      <link rel="stylesheet" href="dash.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Inter', Arial, sans-serif;
            background: linear-gradient(135deg, #0f0f0f, #1f1f1f);
            color: #fff;
            line-height: 1.6;
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }
        .nav-brand {
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #fff;
            transition: transform 0.3s ease;
        }
        .nav-brand:hover {
            transform: scale(1.05);
        }
        .nav-links a {
            color: rgba(255, 255, 255, 0.9);
            margin-left: 1.5rem;
            text-decoration: none;
            font-weight: 500;
            font-size: 1rem;
            transition: color 0.3s ease, border-bottom 0.2s ease;
        }
        .nav-links a.active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }
        .nav-links a:hover {
            color: #60a5fa;
        }
       .dropdown {
    position: relative;
    display: inline-block;
    margin-left: 600px; /* pushes right in flex/grid/with parent */
}

        .dropbtn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .dropbtn:hover {
            color: #3b82f6;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background: #1a1a1a;
            min-width: 180px;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            overflow: hidden;
        }
        .dropdown-content a {
            color: #fff;
            padding: 0.75rem 1rem;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.2rem;
            transition: background 0.3s ease;
        }
        .dropdown-content a:hover {
            background: #2a2a2a;
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }
        nav.navbar {
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        h1 {
            text-align: center;
            margin: 2rem 0;
            font-size: 2rem;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .container {
            display: flex;
            gap: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .cart-left {
            flex: 3;
            background: #1a1a1a;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease;
        }
        .cart-left:hover {
            transform: translateY(-4px);
        }
        .cart-section {
            margin-bottom: 1.5rem;
        }
        .cart-section h3 {
            font-size: 1.2rem;
            color: #fff;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }
        .cart-section label {
            display: block;
            margin-bottom: 0.5rem;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
        }
        .cart-section input, .cart-section select {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: #2a2a2a;
            color: #fff;
            font-size: 0.9rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .cart-section input:focus, .cart-section select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .cart-section select {
            appearance: none;
            background: #2a2a2a url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjIiPjxwYXRoIGQ9Ik02IDlsNiA2IDYtNiIvPjwvc3ZnPg==') no-repeat right 10px center;
        }
        .cart-section .verify-btn {
            background: #3b82f6;
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        .cart-section .verify-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        .cart-section .verify-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .cart-right {
            flex: 1;
            background: #1a1a1a;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease;
        }
        .cart-right:hover {
            transform: translateY(-4px);
        }
        .cart-right h3 {
            margin-bottom: 1rem;
            font-size: 1.2rem;
            color: #fff;
            font-weight: 600;
        }
        .summary-line {
            display: flex;
            justify-content: space-between;
            margin: 0.75rem 0;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
        }
        .total {
            font-weight: 700;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding-top: 0.75rem;
            margin-top: 1rem;
            font-size: 1rem;
            color: #3b82f6;
        }
        .place-order-btn {
            width: 100%;
            background: #3b82f6;
            border: none;
            color: #fff;
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        .place-order-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .place-order-btn:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-2px);
        }
        #loader {
            display: none;
            text-align: center;
            margin-top: 1rem;
        }
        #loader i {
            font-size: 1.5rem;
            color: #3b82f6;
        }
        .cart-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.3s ease;
        }
        .cart-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .cart-item img {
            width: 60px;
            height: 60px;
            margin-right: 0.75rem;
            border-radius: 8px;
            object-fit: cover;
        }
        .notification {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            color: #fff;
            z-index: 3000;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 320px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        .notification.hide {
            transform: translateX(400px);
            opacity: 0;
        }
        .notification-success {
            border-left: 4px solid #10b981;
        }
        .notification-error {
            border-left: 4px solid #ef4444;
        }
        .notification-info {
            border-left: 4px solid #3b82f6;
        }
        .notification-warning {
            border-left: 4px solid #f59e0b;
        }
        .notification-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .notification-icon {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .notification-success .notification-icon {
            color: #10b981;
        }
        .notification-error .notification-icon {
            color: #ef4444;
        }
        .notification-info .notification-icon {
            color: #3b82f6;
        }
        .notification-warning .notification-icon {
            color: #f59e0b;
        }
        .notification-message {
            flex: 1;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        .notification-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s ease;
        }
        .notification-close:hover {
            color: #fff;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            display: none;
        }
        .modal-content {
            background: #1a1a1a;
            padding: 1.5rem;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            position: relative;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .modal-close:hover {
            color: #3b82f6;
        }
        .modal-content h2 {
            margin-bottom: 1.5rem;
            color: #fff;
            font-size: 1.5rem;
            font-weight: 600;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            color: #fff;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: transparent;
            color: #fff;
            font-size: 0.9rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .modal-content p {
            margin-top: 1rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            font-size: 0.85rem;
        }
        .modal-content p a {
            color: #3b82f6;
            text-decoration: none;
        }
        .modal-content p a:hover {
            text-decoration: underline;
        }
        .login-btn {
            background: #3b82f6;
            color: #fff;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            width: 100%;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        .login-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        .login-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                padding: 1rem;
            }
            .nav-brand {
                font-size: 1.2rem;
            }
            .nav-links a {
                margin-left: 1rem;
                font-size: 0.9rem;
            }
            .notification {
                top: 1rem;
                right: 1rem;
                left: 1rem;
                max-width: none;
                transform: translateY(-100px);
            }
            .notification.show {
                transform: translateY(0);
            }
            .notification.hide {
                transform: translateY(-100px);
            }
            .cart-item img {
                width: 50px;
                height: 50px;
            }
            h1 {
                font-size: 1.5rem;
            }
        }
        @media (max-width: 480px) {
            .modal-content {
                width: 95%;
                padding: 1rem;
            }
            .cart-section h3, .cart-right h3 {
                font-size: 1rem;
            }
            .place-order-btn {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
     <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <span class="logo-text">NEXUS</span>
                <span class="logo-subtitle">STORE</span>
            </div>
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-link">Home</a>
                <a href="product.html" class="nav-link">Products</a>
                <a href="dashboard.html#categories" class="nav-link">Categories</a>
                <a href="dashboard.html#deals" class="nav-link">Deals</a>
                <a href="dashboard.html#about" class="nav-link">About</a>
            </div>
        <div class="dropdown">
            <button class="dropbtn"><i class="fa-solid fa-bars"></i></button>
            <div class="dropdown-content">
                <a href="profile.html"><i class="fa-solid fa-id-card"></i> Profile Info</a>
                <a href="orders.html"><i class="fa-solid fa-box"></i> My Orders</a>
                <a href="cart.html"><i class="fa-solid fa-cart-shopping"></i> Cart</a>
                <a href="wishlist.html"><i class="fa-solid fa-heart"></i> Wishlist</a>
                <a href="#" id="login-link"><i class="fa-solid fa-sign-in-alt"></i> Login</a>
                <a href="index.html" id="logout-link" style="display: none;"><i class="fa-solid fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </nav>

    <div class="modal" id="login-modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2>Login to NEXUS Store</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="login-btn">Login</button>
            </form>
            <p>Don't have an account? <a href="#" class="signup-link">Sign Up</a></p>
        </div>
    </div>

    <div class="modal" id="signup-modal">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2>Sign Up for NEXUS Store</h2>
            <form id="signup-form">
                <div class="form-group">
                    <label for="signup-name">Name</label>
                    <input type="text" id="signup-name" placeholder="Enter your name" required>
                </div>
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="login-btn">Sign Up</button>
            </form>
            <p>Already have an account? <a href="#" class="login-link">Login</a></p>
        </div>
    </div>

    <h1>🛒 Complete Your Purchase</h1>

    <div class="container">
        <div class="cart-left">
            <div class="cart-section">
                <h3>Delivery Address</h3>
                <label for="address">Address:</label>
                <input type="text" id="address" placeholder="Enter your delivery address">
            </div>
            <div class="cart-section">
                <h3>Email Verification</h3>
                <label for="email">Email Address:</label>
                <input type="email" id="email" placeholder="Enter your email">
                <button class="verify-btn" id="sendEmailOtpBtn">Send OTP</button>
                <div id="otpSection" style="display: none;">
                    <label for="emailOtp">Enter OTP:</label>
                    <input type="text" id="emailOtp" placeholder="Enter OTP">
                    <button class="verify-btn" id="verifyEmailOtpBtn">Verify OTP</button>
                </div>
            </div>
            <div class="cart-section">
                <h3>Payment Options</h3>
                <label for="paymentMethod">Select Payment Method:</label>
                <select id="paymentMethod">
                    <option value="credit-card">Credit Card</option>
                    <option value="debit-card">Debit Card</option>
                    <option value="paypal">PayPal</option>
                    <option value="cash-on-delivery">Cash on Delivery</option>
                </select>
            </div>
            <div class="cart-section">
                <h3>Order Summary</h3>
                <div id="cartItems"></div>
                <p>Items: <span id="itemCount">0</span></p>
                <p>Total: <span id="summaryTotal">$0</span></p>
            </div>
        </div>
        <div class="cart-right">
            <h3>Price Details</h3>
            <div class="summary-line"><span>Price</span><span id="priceTotal">$0</span></div>
            <div class="summary-line"><span>Discount (10%)</span><span style="color:#10b981;" id="discountAmt">− $0</span></div>
            <div class="summary-line"><span>Delivery Fee</span><span id="deliveryFee">$10</span></div>
            <div class="summary-line total"><span>Total Amount</span><span id="finalTotal">$0</span></div>
            <div id="loader">
                <i class="fa fa-spinner fa-spin"></i>
                <p style="color:#fff; font-size:0.85rem;">Processing your order...</p>
            </div>
            <button class="place-order-btn" id="placeOrderBtn" disabled>Place Order</button>
        </div>
    </div>

    <script>
        const mockProducts = {
            "1": {
                id: "1",
                name: "Premium Wireless Headphones",
                description: "High-quality sound with noise cancellation and up to 30 hours of battery life.",
                currentPrice: "$299",
                originalPrice: "$399",
                image: "https://images.pexels.com/photos/788946/pexels-photo-788946.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop",
                badge: "Best Seller",
                badgeClass: "best-seller",
                stars: "★★★★★",
                ratingCount: "(124 reviews)"
            },
            "2": {
                id: "2",
                name: "Smart Fitness Watch",
                description: "Track your health and fitness goals with advanced sensors and a sleek design.",
                currentPrice: "$199",
                image: "https://images.pexels.com/photos/90946/pexels-photo-90946.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop",
                badge: "New",
                badgeClass: "new",
                stars: "★★★★☆",
                ratingCount: "(89 reviews)"
            },
            "3": {
                id: "3",
                name: "Ultra-thin Laptop",
                description: "Powerful performance in a sleek design, perfect for work and play.",
                currentPrice: "$899",
                originalPrice: "$1,199",
                image: "https://images.pexels.com/photos/341523/pexels-photo-341523.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop",
                badge: "Sale",
                badgeClass: "sale",
                stars: "★★★★★",
                ratingCount: "(256 reviews)"
            },
            "4": {
                id: "4",
                name: "Premium Sneakers",
                description: "Comfortable and stylish footwear for everyday wear.",
                currentPrice: "$149",
                image: "https://images.pexels.com/photos/1649771/pexels-photo-1649771.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop",
                stars: "★★★★☆",
                ratingCount: "(67 reviews)"
            },
            "5": {
                id: "5",
                name: "Latest Smartphone",
                description: "Cutting-edge technology in your pocket with a stunning display and camera.",
                currentPrice: "$799",
                image: "https://images.pexels.com/photos/4158/apple-iphone-smartphone-desk.jpg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop",
                badge: "Hot",
                badgeClass: "hot",
                stars: "★★★★★",
                ratingCount: "(342 reviews)"
            },
            "6": {
                id: "6",
                name: "Premium Coffee Maker",
                description: "Brew the perfect cup every time with advanced brewing technology.",
                currentPrice: "$249",
                originalPrice: "$299",
                image: "https://images.pexels.com/photos/276517/pexels-photo-276517.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop",
                stars: "★★★★☆",
                ratingCount: "(78 reviews)"
            }
        };

      let ws = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const reconnectDelay = 5000;
let sessionToken = null;
let user = { name: 'Guest', email: null };
let isSessionValidated = false;
let isEmailVerified = false;
let verifiedEmail = '';
const cartItemsEl = document.getElementById('cartItems');
const itemCountEl = document.getElementById('itemCount');
const summaryTotalEl = document.getElementById('summaryTotal');
const priceTotalEl = document.getElementById('priceTotal');
const discountAmtEl = document.getElementById('discountAmt');
const deliveryFeeEl = document.getElementById('deliveryFee');
const finalTotalEl = document.getElementById('finalTotal');
const placeOrderBtn = document.getElementById('placeOrderBtn');
const addressInput = document.getElementById('address');
const emailInput = document.getElementById('email');
const emailOtpInput = document.getElementById('emailOtp');
const sendEmailOtpBtn = document.getElementById('sendEmailOtpBtn');
const verifyEmailOtpBtn = document.getElementById('verifyEmailOtpBtn');
const paymentMethod = document.getElementById('paymentMethod');
const loader = document.getElementById('loader');
const otpSection = document.getElementById('otpSection');
const loginLink = document.getElementById('login-link');
const logoutLink = document.getElementById('logout-link');
let cartItems = [];

function setCookie(name, value, days) {
    const expires = new Date(Date.now() + days * 864e5).toUTCString();
    document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/`;
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    return parts.length === 2 ? decodeURIComponent(parts.pop().split(';').shift()) : null;
}

function isLoggedIn() {
    return !!sessionToken && isSessionValidated;
}

function requireLogin() {
    showNotification('Please login to continue', 'warning');
    document.getElementById('login-modal').style.display = 'block';
    return false;
}

function updatePlaceOrderButton() {
    placeOrderBtn.disabled = !isLoggedIn() || !isEmailVerified || !addressInput.value.trim() || cartItems.length === 0;
}

function connectWebSocket() {
    ws = new WebSocket('wss://nexus-store-2.onrender.com');
    console.log('Attempting WebSocket connection...');

    ws.onopen = () => {
        console.log('Connected to WebSocket server');
        reconnectAttempts = 0;
        sessionToken = getCookie('sessionToken');
        if (sessionToken) {
            ws.send(JSON.stringify({ type: 'validateSession', payload: { sessionToken } }));
        } else {
            isSessionValidated = false;
            updateUIForGuest();
            requireLogin();
        }
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log('WebSocket message:', data);
        const { status, message, user: userData, type, sessionToken: newToken, cart } = data;
        showNotification(message, status);

        if (status === 'success') {
            if (type === 'login' || type === 'signup') {
                sessionToken = newToken;
                setCookie('sessionToken', sessionToken, 4);
                user = userData || { name: 'Guest', email: null };
                isSessionValidated = true;
                updateUIForUser();
                document.getElementById(type === 'login' ? 'login-modal' : 'signup-modal').style.display = 'none';
                emailInput.value = user.email || '';
                loadCart();
            } else if (type === 'validateSession') {
                user = userData || { name: 'Guest', email: null };
                cartItems = cart || [];
                isSessionValidated = true;
                updateUIForUser();
                emailInput.value = user.email || '';
                loadCart();
            } else if (type === 'logout') {
                sessionToken = null;
                setCookie('sessionToken', '', -1);
                user = { name: 'Guest', email: null };
                isSessionValidated = false;
                isEmailVerified = false;
                verifiedEmail = '';
                cartItems = [];
                updateUIForGuest();
                loadCart();
                requireLogin();
            } else if (type === 'sendEmailOtp') {
                otpSection.style.display = 'block';
                emailInput.disabled = true;
                sendEmailOtpBtn.style.display = 'none';
            } else if (type === 'verifyEmailOtp') {
                isEmailVerified = true;
                verifiedEmail = emailInput.value;
                otpSection.style.display = 'none';
                emailInput.disabled = true;
                verifyEmailOtpBtn.style.display = 'none';
                updatePlaceOrderButton();
            } else if (type === 'placeOrder') {
                showNotification('Order placed successfully!', 'success');
                localStorage.removeItem('cartItems'); // Clear cart after order
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
        } else if (status === 'error' && message.includes('session')) {
            sessionToken = null;
            setCookie('sessionToken', '', -1);
            user = { name: 'Guest', email: null };
            isSessionValidated = false;
            isEmailVerified = false;
            verifiedEmail = '';
            cartItems = [];
            updateUIForGuest();
            loadCart();
            requireLogin();
        }
    };

    ws.onerror = (err) => {
        console.error('WebSocket error:', err);
        showNotification('Failed to connect to server', 'error');
    };

    ws.onclose = () => {
        console.log('WebSocket connection closed');
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`Reconnecting in ${reconnectDelay / 1000}s... (Attempt ${reconnectAttempts}/${maxReconnectAttempts})`);
            setTimeout(connectWebSocket, reconnectDelay);
        } else {
            showNotification('Unable to connect to server after multiple attempts', 'error');
            isSessionValidated = false;
            isEmailVerified = false;
            updateUIForGuest();
            loadCart();
            requireLogin();
        }
    };
}

function updateUIForUser() {
    loginLink.style.display = 'none';
    logoutLink.style.display = 'block';
    updatePlaceOrderButton();
}

function updateUIForGuest() {
    loginLink.style.display = 'block';
    logoutLink.style.display = 'none';
    cartItemsEl.innerHTML = '<p>Please login to view your order.</p>';
    itemCountEl.textContent = '0';
    summaryTotalEl.textContent = '$0';
    priceTotalEl.textContent = '$0';
    discountAmtEl.textContent = '− $0';
    finalTotalEl.textContent = '$0';
    placeOrderBtn.disabled = true;
    isEmailVerified = false;
    verifiedEmail = '';
    emailInput.disabled = false;
    emailInput.value = '';
    otpSection.style.display = 'none';
    sendEmailOtpBtn.style.display = 'block';
    verifyEmailOtpBtn.style.display = 'block';
}

function loadCart() {
    // Load cart from localStorage or WebSocket
    const storedCart = localStorage.getItem('cartItems');
    if (storedCart) {
        cartItems = JSON.parse(storedCart);
    }
    renderCart();
}

function renderCart() {
    if (!isLoggedIn()) {
        cartItemsEl.innerHTML = '<p>Please login to view your order.</p>';
        itemCountEl.textContent = '0';
        summaryTotalEl.textContent = '$0';
        priceTotalEl.textContent = '$0';
        discountAmtEl.textContent = '− $0';
        finalTotalEl.textContent = '$0';
        placeOrderBtn.disabled = true;
        return;
    }

    if (cartItems.length === 0) {
        cartItemsEl.innerHTML = '<p>Your cart is empty. <a href="electronics.html">Shop now</a></p>';
        itemCountEl.textContent = '0';
        summaryTotalEl.textContent = '$0';
        priceTotalEl.textContent = '$0';
        discountAmtEl.textContent = '− $0';
        finalTotalEl.textContent = '$0';
        placeOrderBtn.disabled = true;
        return;
    }

    let totalPrice = 0;
    let totalItems = 0;
    cartItemsEl.innerHTML = '';

    cartItems.forEach(item => {
        const price = parseFloat(item.price.replace('$', '')) || 0;
        const quantity = item.quantity || 1;
        totalPrice += price * quantity;
        totalItems += quantity;

        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item';
        cartItem.innerHTML = `
            <img src="${item.image}" alt="${item.name}">
            <div>
                <p><strong>${item.name}</strong></p>
                <p>${item.price} x ${quantity}</p>
            </div>
        `;
        cartItemsEl.appendChild(cartItem);
    });

    const discount = totalPrice * 0.1; // 10% discount
    const deliveryFee = 10;
    const finalAmount = totalPrice - discount + deliveryFee;

    itemCountEl.textContent = totalItems;
    summaryTotalEl.textContent = `$${finalAmount.toFixed(2)}`;
    priceTotalEl.textContent = `$${totalPrice.toFixed(2)}`;
    discountAmtEl.textContent = `− $${discount.toFixed(2)}`;
    deliveryFeeEl.textContent = `$${deliveryFee.toFixed(2)}`;
    finalTotalEl.textContent = `$${finalAmount.toFixed(2)}`;
    updatePlaceOrderButton();
}

function showNotification(message, type = 'info') {
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) existingNotification.remove();
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-icon">${getNotificationIcon(type)}</span>
            <span class="notification-message">${message}</span>
            <button class="notification-close">&times;</button>
        </div>
    `;
    document.body.appendChild(notification);
    setTimeout(() => notification.classList.add('show'), 100);
    const autoRemove = setTimeout(() => removeNotification(notification), 4000);
    notification.querySelector('.notification-close').addEventListener('click', () => {
        clearTimeout(autoRemove);
        removeNotification(notification);
    });
}

function getNotificationIcon(type) {
    const icons = { success: '✓', error: '✕', info: 'ℹ', warning: '⚠' };
    return icons[type] || icons.info;
}

function removeNotification(notification) {
    notification.classList.add('hide');
    setTimeout(() => notification.parentNode?.removeChild(notification), 300);
}

document.addEventListener('DOMContentLoaded', () => {
    connectWebSocket();

    const loginModal = document.getElementById('login-modal');
    const signupModal = document.getElementById('signup-modal');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const modalCloses = document.querySelectorAll('.modal-close');
    const signupLink = document.querySelector('.signup-link');
    const loginLinkEl = document.querySelector('.login-link');

    loginLink.addEventListener('click', (e) => {
        e.preventDefault();
        loginModal.style.display = 'block';
    });

    logoutLink.addEventListener('click', (e) => {
        e.preventDefault();
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'logout', payload: { sessionToken } }));
        } else {
            showNotification('Cannot logout: Server not connected', 'error');
        }
    });

    modalCloses.forEach(close => {
        close.addEventListener('click', () => {
            loginModal.style.display = 'none';
            signupModal.style.display = 'none';
        });
    });

    signupLink.addEventListener('click', (e) => {
        e.preventDefault();
        loginModal.style.display = 'none';
        signupModal.style.display = 'block';
    });

    loginLinkEl.addEventListener('click', (e) => {
        e.preventDefault();
        signupModal.style.display = 'none';
        loginModal.style.display = 'block';
    });

    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            showNotification('Cannot login: Server not connected', 'error');
            return;
        }
        const submitBtn = loginForm.querySelector('.login-btn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Logging In...';
        submitBtn.disabled = true;
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        ws.send(JSON.stringify({ type: 'login', payload: { email, password } }));
        setTimeout(() => {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }, 2000);
    });

    signupForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            showNotification('Cannot sign up: Server not connected', 'error');
            return;
        }
        const submitBtn = signupForm.querySelector('.login-btn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Signing Up...';
        submitBtn.disabled = true;
        const name = document.getElementById('signup-name').value.trim();
        const email = document.getElementById('signup-email').value.trim();
        const password = document.getElementById('signup-password').value;
        ws.send(JSON.stringify({ type: 'signup', payload: { name, email, password } }));
        setTimeout(() => {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }, 2000);
    });

    sendEmailOtpBtn.addEventListener('click', () => {
        if (!isLoggedIn()) {
            showNotification('Please login to verify your email', 'warning');
            loginModal.style.display = 'block';
            return;
        }
        const email = emailInput.value.trim();
        if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            showNotification('Enter a valid email address', 'error');
            return;
        }
        sendEmailOtpBtn.disabled = true;
        sendEmailOtpBtn.textContent = 'Sending...';
        ws.send(JSON.stringify({ type: 'sendEmailOtp', payload: { sessionToken, email } }));
        setTimeout(() => {
            sendEmailOtpBtn.disabled = false;
            sendEmailOtpBtn.textContent = 'Send OTP';
        }, 2000);
    });

    verifyEmailOtpBtn.addEventListener('click', () => {
        if (!isLoggedIn()) {
            showNotification('Please login to verify OTP', 'warning');
            loginModal.style.display = 'block';
            return;
        }
        const email = emailInput.value.trim();
        const otp = emailOtpInput.value.trim();
        if (!otp) {
            showNotification('Enter the OTP', 'error');
            return;
        }
        verifyEmailOtpBtn.disabled = true;
        verifyEmailOtpBtn.textContent = 'Verifying...';
        ws.send(JSON.stringify({ type: 'verifyEmailOtp', payload: { sessionToken, email, otp } }));
        setTimeout(() => {
            verifyEmailOtpBtn.disabled = false;
            verifyEmailOtpBtn.textContent = 'Verify OTP';
        }, 2000);
    });

    addressInput.addEventListener('input', updatePlaceOrderButton);

    placeOrderBtn.addEventListener('click', () => {
        if (!isLoggedIn()) {
            showNotification('Please login to place the order', 'warning');
            loginModal.style.display = 'block';
            return;
        }
        if (!isEmailVerified) {
            showNotification('Please verify your email before placing the order', 'error');
            return;
        }
        const address = addressInput.value.trim();
        const paymentMethodValue = paymentMethod.value;
        if (!address) {
            showNotification('Please enter a delivery address', 'error');
            return;
        }
        if (cartItems.length === 0) {
            showNotification('Your cart is empty', 'error');
            return;
        }
        loader.style.display = 'block';
        placeOrderBtn.disabled = true;
        placeOrderBtn.textContent = 'Processing...';
        const orderData = {
            items: cartItems.map(item => ({
                id: item.id,
                name: item.name,
                price: item.price,
                quantity: item.quantity,
                image: item.image
            })),
            shippingAddress: address,
            paymentMethod: paymentMethodValue
        };
        ws.send(JSON.stringify({ type: 'placeOrder', order: orderData, payload: { sessionToken } }));
        setTimeout(() => {
            loader.style.display = 'none';
            placeOrderBtn.textContent = 'Place Order';
            updatePlaceOrderButton();
        }, 2000);
    });
});

console.log('🔍 Buy Now Page Loaded Successfully!');
</script>
</body>
</html>